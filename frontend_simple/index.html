<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DeFi Risk Sentinel ¬∑ On-chain Risk Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts (can be removed if blocked in your region) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Icons via jsDelivr -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg-app: #020617;
      --bg-surface: #050816;
      --bg-soft: #050816;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --border-strong: rgba(15, 23, 42, 0.85);

      --accent: #a855f7;
      --accent-soft: rgba(168, 85, 247, 0.18);

      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-subtle: #6b7280;

      --risk-0: #22c55e;
      --risk-1: #eab308;
      --risk-2: #f97316;
      --risk-3: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .app-shell {
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr);
      width: 100%;
      min-height: 100vh;
    }

    @media (max-width: 900px) {
      .app-shell {
        grid-template-columns: 70px minmax(0, 1fr);
      }
    }

    .sidebar {
      border-right: 1px solid var(--border-strong);
      background: radial-gradient(circle at top, #020617, #020617 55%, #020617);
      display: flex;
      flex-direction: column;
      padding: 16px 14px;
      gap: 18px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
    }

    .sidebar-logo-mark {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0f172a);
      border: 1px solid rgba(248, 250, 252, 0.7);
      box-shadow:
        0 0 16px rgba(168, 85, 247, 0.6),
        0 0 0 1px rgba(15, 23, 42, 0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: #f9fafb;
    }

    .sidebar-logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sidebar-logo-title {
      font-size: 13px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .sidebar-logo-sub {
      font-size: 11px;
      color: var(--text-subtle);
    }

    @media (max-width: 900px) {
      .sidebar-logo-text {
        display: none;
      }
    }

    .sidebar-nav {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 12px;
    }

    .nav-section-label {
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 10px;
      color: var(--text-subtle);
      padding: 0 6px;
    }

    .nav-list {
      list-style: none;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      border-radius: 999px;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: var(--text-muted);
      border: 1px solid transparent;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease,
        transform 0.1s ease;
    }

    .nav-item i {
      font-size: 14px;
      width: 18px;
      display: flex;
      justify-content: center;
    }

    .nav-item span {
      white-space: nowrap;
    }

    .nav-item:hover {
      background: rgba(15, 23, 42, 0.95);
      border-color: var(--border-subtle);
      color: #e5e7eb;
      transform: translateY(-1px);
    }

    .nav-item.active {
      background: radial-gradient(circle at top left, var(--accent-soft), transparent),
        linear-gradient(145deg, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.98));
      border-color: rgba(248, 250, 252, 0.06);
      color: #fefce8;
    }

    @media (max-width: 900px) {
      .nav-item span {
        display: none;
      }
    }

    .sidebar-footer {
      margin-top: auto;
      padding: 4px 4px 0;
      font-size: 11px;
      color: var(--text-subtle);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sidebar-footer-pill {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.95);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--text-muted);
    }

    @media (max-width: 900px) {
      .sidebar-footer-text {
        display: none;
      }
    }

    .main {
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 100vh;
    }

    .topbar {
      height: 56px;
      border-bottom: 1px solid var(--border-strong);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), #020617);
    }

    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .topbar-title {
      font-size: 13px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(209, 213, 219, 0.96);
    }

    .topbar-subtitle {
      font-size: 11px;
      color: var(--text-subtle);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
    }

    .status-pill {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
    }

    .content {
      flex: 1;
      padding: 18px 18px 22px;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 1024px) {
      .content {
        grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.2fr);
      }
    }

    @media (max-width: 900px) {
      .content {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), #020617);
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, 0.95);
      box-shadow:
        0 24px 60px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(15, 23, 42, 0.95);
      padding: 16px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }

    .panel-title {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .panel-subtitle {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 2px;
    }

    .panel-header-right {
      font-size: 11px;
      color: var(--text-subtle);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge-soft {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 10px;
      background: rgba(15, 23, 42, 0.95);
      color: rgba(209, 213, 219, 0.96);
    }

    .risk-layout {
      display: grid;
      grid-template-columns: auto minmax(0, 1.3fr);
      gap: 16px;
      align-items: center;
      margin-top: 4px;
    }

    @media (max-width: 640px) {
      .risk-layout {
        grid-template-columns: minmax(0, 1fr);
        align-items: flex-start;
      }
    }

    .risk-orb-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .risk-traffic {
      min-width: 190px;
      height: 64px;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: rgba(15, 23, 42, 0.96);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      box-shadow:
        0 18px 50px rgba(0, 0, 0, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.95);
    }

    .risk-emoji {
      font-size: 30px;
      filter: drop-shadow(0 0 6px rgba(248, 250, 252, 0.4));
    }

    .risk-traffic-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .risk-traffic-level {
      font-size: 13px;
      font-weight: 600;
      color: rgba(249, 250, 251, 0.98);
    }

    .risk-traffic-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-subtle);
    }

    .risk-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }

    .risk-head-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .risk-pill-main {
      font-size: 11px;
      padding: 2px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
    }

    .risk-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .risk-meta-row span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .risk-meta-row code {
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31, 41, 55, 0.9);
      color: rgba(209, 213, 219, 0.9);
    }

    .chart-card {
      margin-top: 8px;
      background: linear-gradient(150deg, #020617, #020617);
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px 12px 12px;
    }

    .chart-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .chart-toolbar span:first-child {
      color: rgba(209, 213, 219, 0.95);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chart-toolbar i {
      font-size: 14px;
    }

    .stat-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .stat-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .stat-card {
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top left, #020617, #020617);
      padding: 9px 10px 11px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: rgba(148, 163, 184, 0.94);
    }

    .stat-label i {
      font-size: 13px;
    }

    .stat-value {
      font-size: 12px;
      font-weight: 500;
      color: rgba(229, 231, 235, 0.98);
    }

    .stat-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .stat-chip {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(156, 163, 175, 0.96);
    }

    .stat-chip.highlight {
      border-color: rgba(34, 197, 94, 0.85);
      color: #bbf7d0;
    }

    .stat-chip.warn {
      border-color: rgba(234, 179, 8, 0.9);
      color: #fef3c7;
    }

    .factor-section {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .factor-group {
      border-radius: 16px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .factor-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    @media (max-width: 640px) {
      .factor-row {
        flex-direction: column;
      }
    }

    .factor-col {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .factor-label {
      font-size: 11px;
      color: rgba(209, 213, 219, 0.97);
    }

    .factor-tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(203, 213, 225, 0.96);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .factor-desc {
      line-height: 1.7;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-mark">DS</div>
        <div class="sidebar-logo-text">
          <div class="sidebar-logo-title">LingNan University</div>
          <div class="sidebar-logo-sub">On-chain Market Monitor</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section-label">OVERVIEW</div>
        <ul class="nav-list">
          <li class="nav-item active">
            <i class="ph-bold ph-gauge"></i>
            <span>Dashboard</span>
          </li>
        </ul>

        <div class="nav-section-label">MARKETS</div>
        <ul class="nav-list">
          <li class="nav-item">
            <i class="ph-bold ph-swap"></i>
            <span>Uniswap V2 ¬∑ USDC / WETH</span>
          </li>
        </ul>

        <div class="nav-section-label">ALERTS</div>
        <ul class="nav-list">
          <li class="nav-item">
            <i class="ph-bold ph-bell-ringing"></i>
            <span>Risk Thresholds & Alerts</span>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-footer-pill">
          <div class="status-dot" id="status-dot"></div>
          <div class="sidebar-footer-text">
            Backend: Python monitor ¬∑ Hardhat-deployed contract
          </div>
        </div>
      </div>
    </aside>

    <div class="main">
      <header class="topbar">
        <div class="topbar-left">
          <div class="topbar-title">CHAIN RISK DASHBOARD</div>
          <div class="topbar-subtitle">
            Based on Ethereum mainnet data ¬∑ Uniswap pool + whale behaviour + CEX flows
          </div>
        </div>
        <div class="topbar-right">
          <div class="status-pill">
            <i class="ph-bold ph-activity"></i>
            <span id="api-status">API Status: Connecting‚Ä¶</span>
          </div>
        </div>
      </header>

      <main class="content">
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">MARKET RISK OVERVIEW</div>
              <div class="panel-subtitle">Current market: UNISWAP_USDC_WETH</div>
            </div>
            <div class="panel-header-right">
              <span>Risk Level: 0 Normal ¬∑ 3 Critical</span>
            </div>
          </div>

          <div class="risk-layout">
            <div class="risk-orb-wrapper">
              <div class="risk-traffic" id="risk-light">
                <div class="risk-emoji" id="risk-emoji">üö•</div>
                <div class="risk-traffic-text">
                  <div class="risk-traffic-level" id="risk-level-text">Level 0</div>
                  <div class="risk-traffic-label" id="risk-label">NORMAL</div>
                </div>
              </div>
            </div>

            <div class="risk-meta">
              <div class="risk-head-row">
                <span>Current risk level:</span>
                <span id="risk-level-desc">Normal ¬∑ background volatility</span>
                <span class="risk-pill-main" id="risk-pill">
                  Example policy: trigger de-risking when level ‚â• 2
                </span>
              </div>
              <div class="risk-meta-row">
                <span><i class="ph-bold ph-swap"></i> Pool: USDC / WETH (V2)</span>
                <span><i class="ph-bold ph-cube"></i> MarketId:
                  <code id="market-id-short">‚Äî</code>
                </span>
              </div>
              <div class="risk-meta-row">
                <span><i class="ph-bold ph-clock"></i> Last update:
                  <span id="last-update">‚Äî</span>
                </span>
                <span><i class="ph-bold ph-database"></i> Records:
                  <span id="record-count">‚Äî</span>
                </span>
              </div>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-toolbar">
              <div>
                <span>
                  <i class="ph-bold ph-wave-square"></i>
                  Risk level time series
                </span>
                <span>Last 100 monitoring points</span>
              </div>
              <div class="badge-soft" id="source-badge">source: multi_factor</div>
            </div>
            <div style="height: 130px;">
              <canvas id="risk-chart"></canvas>
            </div>
          </div>

          <div class="stat-grid">
            <div class="stat-card">
              <div class="stat-label">
                <i class="ph-bold ph-arrows-left-right"></i>
                DEX Activity
              </div>
              <div class="stat-value" id="dex-volume">‚Äî</div>
              <div class="stat-chips">
                <div class="stat-chip highlight" id="dex-trades">‚Äî swaps</div>
                <div class="stat-chip">Volume vs. pool liquidity is computed on backend</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-label">
                <i class="ph-bold ph-whatsapp-logo"></i>
                Whales & CEX Behaviour
              </div>
              <div class="stat-value" id="whale-summary">‚Äî</div>
              <div class="stat-chips">
                <div class="stat-chip warn" id="whale-sell">Whale selling: ‚Äî</div>
                <div class="stat-chip" id="cex-flow">CEX net inflow: ‚Äî</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-label">
                <i class="ph-bold ph-activity"></i>
                Strategy Hint
              </div>
              <div class="stat-value" id="hint-text">
                Overall risk is low; focus on monitoring, normal position size is acceptable.
              </div>
              <div class="stat-chips">
                <div class="stat-chip" id="hint-chip-1">Status: Observation</div>
                <div class="stat-chip" id="hint-chip-2">Suggestion: Normal exposure / low leverage</div>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">SIGNAL COMPOSITION</div>
              <div class="panel-subtitle">Multi-factor risk signal & contract interaction</div>
            </div>
          </div>

          <div class="factor-section">
            <div class="factor-group">
              <div class="factor-row">
                <div class="factor-col">
                  <div class="factor-label">On-chain data inputs</div>
                  <div class="factor-tag">
                    <i class="ph-bold ph-swap"></i>
                    Uniswap V2 ¬∑ Swap events
                  </div>
                  <div class="factor-tag">
                    <i class="ph-bold ph-database"></i>
                    getReserves() ¬∑ pool liquidity
                  </div>
                  <div class="factor-tag">
                    <i class="ph-bold ph-link-simple"></i>
                    Etherscan API ¬∑ whales / exchange addresses
                  </div>
                </div>
                <div class="factor-col" style="text-align: right;">
                  <div class="factor-label">Contract-side interface</div>
                  <div class="factor-tag">
                    RiskMonitor.updateRisk(marketId, level)
                  </div>
                  <div class="factor-tag">
                    keeper = Python monitoring script
                  </div>
                </div>
              </div>
            </div>

            <div class="factor-group">
              <div class="factor-row">
                <div class="factor-col">
                  <div class="factor-label">Risk factor components</div>
                  <div class="factor-tag">DEX volume & trade count</div>
                  <div class="factor-tag">Whale sell size / number of addresses</div>
                  <div class="factor-tag">CEX hot-wallet net inflow (ETH)</div>
                </div>
                <div class="factor-col" style="text-align: right;">
                  <div class="factor-label">Risk level ranges</div>
                  <div class="factor-tag">L0 Normal ¬∑ L1 Watch</div>
                  <div class="factor-tag">L2 Alert ¬∑ L3 Danger</div>
                </div>
              </div>
            </div>

            <div class="factor-group">
              <div class="factor-label" style="margin-bottom: 4px;">
                Use cases for users & strategies
              </div>
              <ul class="factor-desc">
                <li>Risk control: when level ‚â• 2, automatically reduce leverage or remove liquidity.</li>
                <li>Market making: adjust quote width and inventory targets by risk lamp colour.</li>
                <li>Research: combine with sentiment / macro factors to build richer risk panels.</li>
              </ul>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const apiStatusEl = document.getElementById("api-status");
    const statusDotEl = document.getElementById("status-dot");

    const riskLevelTextEl = document.getElementById("risk-level-text");
    const riskLabelEl = document.getElementById("risk-label");
    const riskLightEl = document.getElementById("risk-light");
    const riskPillEl = document.getElementById("risk-pill");
    const riskLevelDescEl = document.getElementById("risk-level-desc");
    const riskEmojiEl = document.getElementById("risk-emoji");

    const marketIdShortEl = document.getElementById("market-id-short");
    const lastUpdateEl = document.getElementById("last-update");
    const recordCountEl = document.getElementById("record-count");
    const sourceBadgeEl = document.getElementById("source-badge");

    const dexVolumeEl = document.getElementById("dex-volume");
    const dexTradesEl = document.getElementById("dex-trades");
    const whaleSummaryEl = document.getElementById("whale-summary");
    const whaleSellEl = document.getElementById("whale-sell");
    const cexFlowEl = document.getElementById("cex-flow");

    const hintTextEl = document.getElementById("hint-text");
    const hintChip1El = document.getElementById("hint-chip-1");
    const hintChip2El = document.getElementById("hint-chip-2");

    let riskChart = null;
    let riskLabels = [];
    let riskLevels = [];
    let lastSeenCreatedAt = null;

    function formatTime(t) {
      if (!t) return "‚Äî";
      return t.replace(" ", " ¬∑ ");
    }

    function applyRiskStyle(level) {
      let color, label, desc, emoji;
      switch (level) {
        case 0:
          color = "var(--risk-0)";
          label = "NORMAL";
          desc = "Normal ¬∑ background volatility";
          emoji = "üü¢";
          break;
        case 1:
          color = "var(--risk-1)";
          label = "WATCH";
          desc = "Watch ¬∑ elevated activity";
          emoji = "üü°";
          break;
        case 2:
          color = "var(--risk-2)";
          label = "ALERT";
          desc = "Alert ¬∑ liquidity and flows may amplify volatility";
          emoji = "üü†";
          break;
        case 3:
          color = "var(--risk-3)";
          label = "DANGER";
          desc = "Danger ¬∑ consider aggressive de-risking or exit";
          emoji = "üî¥";
          break;
        default:
          color = "var(--risk-0)";
          label = "UNKNOWN";
          desc = "Unknown";
          emoji = "‚ö™Ô∏è";
      }

      riskLevelTextEl.textContent = "Level " + level;
      riskLabelEl.textContent = label;
      riskLevelDescEl.textContent = desc;

      if (riskEmojiEl) {
        riskEmojiEl.textContent = emoji;
      }

      riskLightEl.style.borderColor = color;
      riskLightEl.style.boxShadow =
        "0 18px 50px rgba(0, 0, 0, 0.95), 0 0 16px " + color + "55";
      riskPillEl.style.borderColor = color;
      riskLabelEl.style.color = color;
    }

    function updateHint(level) {
      if (level <= 0) {
        hintTextEl.textContent =
          "Overall risk is low; monitor activity and liquidity, normal position size is acceptable.";
        hintChip1El.textContent = "Status: Observation";
        hintChip2El.textContent = "Suggestion: Normal exposure / low leverage";
      } else if (level === 1) {
        hintTextEl.textContent =
          "Trading activity is picking up; pay more attention to whales and CEX flows.";
        hintChip1El.textContent = "Status: Mild attention";
        hintChip2El.textContent = "Suggestion: Control risk exposure";
      } else if (level === 2) {
        hintTextEl.textContent =
          "Multi-factor signals are tight; risk of amplified moves or cascades, consider reducing exposure.";
        hintChip1El.textContent = "Status: Elevated risk";
        hintChip2El.textContent = "Suggestion: Reduce size / leverage";
      } else if (level >= 3) {
        hintTextEl.textContent =
          "Composite indicators are in danger zone; extreme moves or severe dislocations may occur.";
        hintChip1El.textContent = "Status: Critical";
        hintChip2El.textContent = "Suggestion: Prioritise capital preservation";
      }
    }

    function initRiskChart(labels, levels) {
      const ctx = document.getElementById("risk-chart").getContext("2d");
      if (riskChart) riskChart.destroy();

      riskChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Risk Level",
              data: levels,
              borderColor: "rgba(249, 115, 22, 0.9)",
              backgroundColor: "rgba(249, 115, 22, 0.16)",
              tension: 0.35,
              fill: true,
              pointRadius: 2,
              pointHoverRadius: 4,
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                color: "rgba(148, 163, 184, 0.9)",
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 5,
              },
              grid: { color: "rgba(31, 41, 55, 0.55)" },
            },
            y: {
              ticks: {
                color: "rgba(148, 163, 184, 0.9)",
                stepSize: 1,
              },
              suggestedMin: -0.1,
              suggestedMax: 3.3,
              grid: {
                color: (ctx) => {
                  if (ctx.tick.value >= 3) return "rgba(239, 68, 68, 0.48)";
                  if (ctx.tick.value >= 2) return "rgba(249, 115, 22, 0.45)";
                  if (ctx.tick.value >= 1) return "rgba(234, 179, 8, 0.4)";
                  return "rgba(31, 41, 55, 0.55)";
                },
                lineWidth: 1,
              },
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `Risk level: ${ctx.parsed.y}`,
              },
            },
          },
        },
      });
    }

    function setApiStatus(ok, message) {
      if (ok) {
        apiStatusEl.textContent = message || "API Status: OK";
        apiStatusEl.style.color = "#bbf7d0";
        statusDotEl.style.background = "#22c55e";
        statusDotEl.style.boxShadow = "0 0 8px rgba(34, 197, 94, 0.8)";
      } else {
        apiStatusEl.textContent = message || "API Status: Error (showing mock data)";
        apiStatusEl.style.color = "#fde68a";
        statusDotEl.style.background = "#eab308";
        statusDotEl.style.boxShadow = "0 0 8px rgba(234, 179, 8, 0.8)";
      }
    }

    function useMockData() {
      setApiStatus(false, "API Status: request failed, showing mock data");

      const mockLabels = ["T-4", "T-3", "T-2", "T-1", "T"];
      const mockLevels = [0, 0, 1, 1, 2];

      riskLabels = mockLabels.slice();
      riskLevels = mockLevels.slice();
      lastSeenCreatedAt = null;

      initRiskChart(riskLabels, riskLevels);

      applyRiskStyle(2);
      updateHint(2);

      marketIdShortEl.textContent = "mock_market";
      lastUpdateEl.textContent = "mock timestamp";
      recordCountEl.textContent = "mock";
      sourceBadgeEl.textContent = "source: mock_data";

      dexVolumeEl.textContent = "‚âà 8.6e19 (mock volume)";
      dexTradesEl.textContent = "‚âà 300 swaps (mock)";
      whaleSummaryEl.textContent = "Mock: no obvious concentrated whale selling recently.";
      whaleSellEl.textContent = "Whale selling: 0 (mock)";
      cexFlowEl.textContent = "CEX net inflow: ~30 ETH (mock)";
    }

    async function loadStatus() {
      try {
        const resp = await fetch("/api/status");
        if (!resp.ok) throw new Error("status not ok");
        const data = await resp.json();

        if (data.ok) {
          const msg = `API Status: OK ¬∑ ${data.records || 0} risk records`;
          setApiStatus(true, msg);

          recordCountEl.textContent = data.records ?? "0";
          if (data.last) {
            marketIdShortEl.textContent =
              (data.last.market_id || "").slice(0, 10) + "‚Ä¶";
            lastUpdateEl.textContent = formatTime(data.last.created_at);
          }
        } else {
          setApiStatus(false, `API Status: error ¬∑ ${data.message} (using mock data)`);
        }
      } catch (e) {
        setApiStatus(false, "API Status: request failed (using mock data)");
      }
    }

    async function initRiskSeries() {
      try {
        const resp = await fetch("/api/risk?limit=100");
        if (!resp.ok) throw new Error("risk not ok");
        const data = await resp.json();

        if (!data.ok || !data.items || data.items.length === 0) {
          useMockData();
          return;
        }

        const items = data.items;
        riskLabels = items.map((r, idx) =>
          r.created_at ? r.created_at.slice(5, 16) : `#${idx + 1}`
        );
        riskLevels = items.map((r) => r.level ?? 0);
        lastSeenCreatedAt = items[items.length - 1].created_at;

        initRiskChart(riskLabels, riskLevels);

        const last = items[items.length - 1];
        const level = last.level ?? 0;
        applyRiskStyle(level);
        updateHint(level);

        marketIdShortEl.textContent =
          (last.market_id || "").slice(0, 10) + "‚Ä¶";
        lastUpdateEl.textContent = formatTime(last.created_at);
        sourceBadgeEl.textContent = `source: ${last.source || "multi_factor"}`;

        dexVolumeEl.textContent =
          "Recent volume and trade count collected (see backend logs & SQLite for details).";
        dexTradesEl.textContent = `Recent sampling points: ${items.length}`;
        whaleSummaryEl.textContent =
          "Whale selling and CEX net inflow are incorporated into the multi-factor score.";
        whaleSellEl.textContent = "Whale selling: see backend monitor logs";
        cexFlowEl.textContent = "CEX net inflow: see backend monitor logs";
      } catch (e) {
        useMockData();
      }
    }

    async function pollRiskSeries() {
      try {
        const resp = await fetch("/api/risk?limit=200");
        if (!resp.ok) return;
        const data = await resp.json();
        if (!data.ok || !data.items || data.items.length === 0) return;

        let items = data.items;

        if (lastSeenCreatedAt) {
          items = items.filter((r) => r.created_at > lastSeenCreatedAt);
        }

        if (items.length === 0) return;

        for (const r of items) {
          const label = r.created_at ? r.created_at.slice(5, 16) : "‚Äî";
          const level = r.level ?? 0;
          riskLabels.push(label);
          riskLevels.push(level);
          lastSeenCreatedAt = r.created_at;
        }

        const maxPoints = 100;
        if (riskLabels.length > maxPoints) {
          riskLabels = riskLabels.slice(-maxPoints);
          riskLevels = riskLevels.slice(-maxPoints);
        }

        if (riskChart) {
          riskChart.data.labels = riskLabels;
          riskChart.data.datasets[0].data = riskLevels;
          riskChart.update("none");
        }

        const last = data.items[data.items.length - 1];
        const level = last.level ?? 0;
        applyRiskStyle(level);
        updateHint(level);

        marketIdShortEl.textContent =
          (last.market_id || "").slice(0, 10) + "‚Ä¶";
        lastUpdateEl.textContent = formatTime(last.created_at);
        sourceBadgeEl.textContent = `source: ${last.source || "multi_factor"}`;
      } catch (e) {
        // silent fail; next poll will try again
      }
    }

    window.addEventListener("load", () => {
      loadStatus();
      initRiskSeries();

      setInterval(loadStatus, 60000);
      setInterval(pollRiskSeries, 60000);
    });
  </script>
</body>
</html>